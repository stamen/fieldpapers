<!DOCTYPE html>
<html>
<head>
    <title>New Box UI</title>
    <script type="text/javascript" src="modestmaps.min.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="raphael-min.js"></script>
    
    <script type="text/javascript">
        function initUI () {
            ////
            // Map
            ////
            var MM = com.modestmaps;
            
            var map = new MM.Map('map', new MM.TemplatedMapProvider('http://tile.openstreetmap.org/{Z}/{X}/{Y}.png'));
                                
            map.setCenterZoom(new MM.Location(37.76, -122.45), 12);
            
            ////
            // UI
            ////
            
            var aspect_ratio = 8.5/11; // Sample aspect_ratio for now // Portrait size
            var factor = 10;
            
            var canvas = Raphael("canvas",1000,500);

            var dragSet = canvas.set();
            
            var rect = canvas.rect(30,30,150*aspect_ratio,150);
            rect.attr("stroke", "#050505");
            rect.attr("fill", "#fff");
            rect.attr("fill-opacity", .33);
            dragSet.push(rect);
            
            var horizontal_add = canvas.rect(30+150*aspect_ratio-.5*15,30+.5*150-.5*25,15,25);
            horizontal_add.attr("stroke", "#050505");
            horizontal_add.attr("fill", "#fff");
            horizontal_add.attr("fill-opacity", 1);
            dragSet.push(horizontal_add);
            
            var vertical_add = canvas.rect(30+.5*150*aspect_ratio-.5*15,30+150-.5*25,15,25);
            vertical_add.attr("stroke", "#050505");
            vertical_add.attr("fill", "#fff");
            vertical_add.attr("fill-opacity", 1);
            dragSet.push(vertical_add);
            
            
            var dragControl = canvas.circle(30,30,15);
            dragControl.attr("fill", "#050505");
            dragControl.attr("fill-opacity", 1);
            dragSet.push(dragControl);
            
            var scaleControl = canvas.circle(150*aspect_ratio + 30,180,15);
            scaleControl.attr("fill", "#fff");
            
            /*
            var plusIcon = canvas.path('M25.979,12.896 19.312,12.896 19.312,6.229 12.647,6.229 12.647,\
                            12.896 5.979,12.896 5.979,19.562 12.647,19.562 12.647,26.229 19.312,\
                            26.229 19.312,19.562 25.979,19.562z');
            plusIcon.attr("fill", "#050505");
            plusIcon.scale(.6,.6,0,0);
            */
            
            var dragDeltaOrigX;
            var dragDeltaOrigY;
            
            var start = function(x,y,e) {
                e.stopPropagation();
                dragSet.oBB = dragSet.getBBox();
                                
                return false;
            },
            move = function (dx,dy,x,y,event) {
                event.stopPropagation();
                var bbox = dragSet.getBBox();
                dragSet.translate(dragSet.oBB.x - bbox.x + dx, dragSet.oBB.y - bbox.y + dy);
                
                scaleControl.translate(dragSet.oBB.x - bbox.x + dx, dragSet.oBB.y - bbox.y + dy);
                return false;
            },
            up = function () {                                
                dragDeltaOrigX = dragSet.getBBox().x - 15;
                dragDeltaOrigY = dragSet.getBBox().y - 15;
            }
            
            dragSet.drag(move, start, up);
            
            var x,y;
            var initialX, initialY;
            scaleControl.drag(
            
            function(dx, dy, mouseX, mouseY, e) {
                //console.log(initialY);
                
                this.attr({
                    cx: Math.max(x + aspect_ratio*dx, 145.909),
                    cy: Math.max(y + dx, 180)
                    //cx: x + dx,
                    //cy: y + dx
                });                
                
                var prev_rect_bbox = rect.getBBox();
                
                rect.remove();
                var rect_width = this.attr("cx");
                var rect_height = this.attr("cy");
                //aspect_ratio*rect_width+30  --> some ratio
                //http://stackoverflow.com/questions/7297356/raphael-js-drag-with-scale-causes-weird-jumping-behavoir
                rect = canvas.rect(prev_rect_bbox.x,prev_rect_bbox.y,rect_width-30,rect_height-30);
                rect.attr("stroke", "#050505");
                rect.attr("fill", "#fff");
                rect.attr("fill-opacity", .33);
                rect.insertBefore(this);
                rect.insertBefore(dragControl);
                rect.insertBefore(horizontal_add);
                //rect.insertBefore(vertical_add); // removing this fixes it?
                
                var new_rect_bbox = rect.getBBox();
                
                var dragOffsetX = dragDeltaOrigX || 0;
                var dragOffsetY = dragDeltaOrigY || 0;
                
                horizontal_add.attr({x: new_rect_bbox.x + new_rect_bbox.width - .5 * 15 - dragOffsetX, 
                                     y: new_rect_bbox.y + .5 * new_rect_bbox.height - .5*25 - dragOffsetY});
                
                   
                vertical_add.attr({x: new_rect_bbox.x + .5 * new_rect_bbox.width - .5*15 - dragOffsetX, 
                                   y: new_rect_bbox.y + new_rect_bbox.height - .5*25 - dragOffsetY});
                
                dragSet.clear();
                createNewDragSet();
                
                return false;
            },
            
            function(mouseX,mouseY,e) {
                e.stopPropagation();
                x = this.attr("cx"),
                y = this.attr("cy")
                
                initialX = x;
                initialY = y;
                                          
                return false;
            },
            
            function(e) {
                this.attr("fill", "#fff");
                
                return false;
            }
            );
            
            var createNewDragSet = function () {
                dragSet.push(rect);
                dragSet.push(dragControl);
                dragSet.push(horizontal_add);
                dragSet.push(vertical_add);
            };
            
            var rect_bounds = rect.getBBox();
            
            var addHorizontalPage = function() {
                // TODO: account for the last rect
                // Check for number of rows
                // Do a bounds check
                //rect_bounds = rect.getBBox();
                
                var x = rect_bounds.x + rect_bounds.width,
                    y = rect_bounds.y,
                    width = rect_bounds.width,
                    height = rect_bounds.height;
            
                var new_rect = canvas.rect(x,y,width,height);
                new_rect.attr("stroke", "#050505");
                new_rect.attr("fill", "#fff");
                new_rect.attr("fill-opacity", .33);
                
                new_rect.insertBefore(horizontal_add);
                //new_rect.insertBefore(scaleControl); //?
                
                dragSet.push(new_rect);
                
                // Move the Horizontal Button and the Scale Control to the correct position
                var new_rect_bounds = new_rect.getBBox();
                scaleControl.attr({                    
                    cx: scaleControl.attr("cx") + new_rect_bounds.width
                });
                
                horizontal_add.attr({
                    x: horizontal_add.attr("x") + new_rect_bounds.width,
                    fill: "#fff"
                });
                
                rect_bounds = new_rect.getBBox();
            }
            
            // Add Pages
            horizontal_add.mousedown(function () {
                this.attr("fill", "#000");
                //addHorizontalPage();
            });
            
            horizontal_add.mouseup(function () {
                addHorizontalPage();
                this.attr("fill", "#fff");
            });
            
            vertical_add.mousedown(function () {
                this.attr("fill", "#000");
            });
            
            vertical_add.mouseup(function () {
                this.attr("fill", "#fff");
            });
            
        }
        
    </script>
    <style type="text/css">
        body {
          background: #fff;
          color: #000;
          font-family: Helvetica, sans-serif;
          margin: 0;
          padding: 20px;
          border: 0;
        }
        #map {
          width: 1000px;
          height: 500px;
          position: absolute;
          z-index: 1;
        }
        
        #canvas {
         position: absolute;
         z-index: 2;
        }
    </style>
</head>
    <body onload="initUI()">
        <h1>New Box UI</h1>
        
        <div id="map">
            <div id="canvas"></div>
        </div>
    </body>
</html>
    