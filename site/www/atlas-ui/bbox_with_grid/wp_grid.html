<!DOCTYPE html>
<html>
<head>
<title>Walking Papers Grid Example</title>
<script type="text/javascript" src="../js/modest_maps/modestmaps.js"></script>
<script type="text/javascript" src="../js/paperjs/lib/paper.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript">
    window.onload = function () {    
        //Set up Modest Maps
        var MM = com.modestmaps;
    
        var map = new MM.Map('map', 
                          new MM.TemplatedMapProvider('http://tile.openstreetmap.org/{Z}/{X}/{Y}.png')); 
    
        map.setCenterZoom(new MM.Location(37.76, -122.45), 12);
        
        paper.install(window); // global
        paper.setup('canvas');
        
        var tool = new Tool();
        var path = new Path();
                
        var size;
        
        var original_point_x;
        var original_point_y;
        
        var topLeft;
        var last_point;
        
        var grid_type;
        var grid_path;
        var grid_path2;
        
        tool.onMouseDown = function(event) {
            if (path) {
                path.remove();
            }
            
            if(grid_path) {
                grid_path.remove();
            }
            
            if (grid_path2) {
                grid_path2.remove();
            }
        
            //var path2 = new Path();
            path.strokeColor = '#e9e9ff';
            path.strokeWidth = 8;
            path.fillColor = '#e9e9ff';
            path.opacity = 0.35;
                        
            original_point_x = event.point.x;
            original_point_y = event.point.y;
                        
            topLeft = new Point(original_point_x,original_point_y);
            size = new Size(10,10);
            path = new Path.Rectangle(topLeft, size);
            path.closed = true;
            path.selected = true;
        }
        
        tool.onMouseDrag = function(event) {
            path.remove();
            
            //size = new Size(Math.abs(original_point_x - event.point.x), Math.abs(original_point_y - event.point.y));
            path = new Path.Rectangle(topLeft,event.point);
            path.strokeColor = '#e9e9ff';
            path.strokeWidth = 8;
            path.fillColor = '#e9e9ff';
            path.opacity = 0.35;
            path.closed = true;
            path.selected = true;
                        
            last_point = event.point;
            
            $("#location").text(map.pointLocation(new com.modestmaps.Point(topLeft.x, topLeft.y)).toString() + ' to ' +
            map.pointLocation(new com.modestmaps.Point(last_point.x, last_point.y)).toString());
        }
        
        tool.onMouseUp = function(event) {
            /*
            if (path) {
                path.selected = false;
            }
            
            if (grid_path) {
                //grid_path.remove();
            }
            */
            
            //Look at current aspect ratio: top_left, last_point
            var width = Math.abs(topLeft.x - last_point.x);
            var height = Math.abs(topLeft.y - last_point.y);
            
            var aspect_ratio = width/height;
            
            if (aspect_ratio < (7.5/9.5)){
                //Width needs to increase.
                width = (7.5 * height)/9.5;
            } else {
                //Height needs to increase.
                height = (9.5 * width)/7.5;
            }
            
            console.log('height: ' + height);
            
            //What is really topLeft?
            if (topLeft.x < last_point.x) {
                last_point.x = topLeft.x + width;
                last_point.y = topLeft.y + height;
            } else {
                topLeft.x = last_point.x + width;
                topLeft.y = last_point.y + height;
            }
            
            path.remove();
            path = new Path.Rectangle(topLeft, last_point);
            console.log(topLeft, last_point);
            path.strokeColor = '#e9e9ff';
            path.strokeWidth = 8;
            path.fillColor = '#e9e9ff';
            path.opacity = 0.35;
            path.closed = true;
            path.selected = true;
            
            grid_type = $("#scale").val();
            console.log(grid_type);
            //add grid
            if (grid_type == "2x2") {
                /*
                //Trying various ways to fraw the grid
                var grid_path1 = new Path.Line(new Point(topLeft.x, topLeft.y + .5 * height), new Point(topLeft.x + width, topLeft.y + .5 * height));
                grid_path1.strokeWidth = 4;
                grid_path1.strokeColor = '#050505';
                grid_path1.opacity = 0.7;
                
                var grid_path2 = new Path.Line(new Point(topLeft.x + .5 * width, topLeft.y), new Point(topLeft.x + .5 * width, topLeft.y + height));
                grid_path2.strokeWidth = 4;
                grid_path2.strokeColor = '#050505';
                grid_path2.opacity = 0.7;
                */
                
                /*
                //moveTo doesn't work                
                grid_path.moveTo(new Point(topLeft.x, topLeft.y + .5 * height));
                grid_path.lineTo(new Point(topLeft.x + width, topLeft.y + .5 * height));
                grid_path.moveTo(new Point(topLeft.x + .5 * width, topLeft.y));
                grid_path.lineTo(new Point(topLeft.x + .5 * width, topLeft.y + height));
                */
                              
                grid_path = new Path();
                grid_path.strokeWidth = 4;
                grid_path.strokeColor = '#050505';
                grid_path.opacity = 0.7;
                
                grid_path.add(new Point(topLeft.x, topLeft.y + .5 * height));
                grid_path.add(new Point(topLeft.x + width, topLeft.y + .5 * height));
                //grid_path.add(new Point(topLeft.x + .5 * width, topLeft.y));
                //grid_path.add(new Point(topLeft.x + .5 * width, topLeft.y + height));
                
                grid_path2 = new Path();
                grid_path2.strokeWidth = 4;
                grid_path2.strokeColor = '#050505';
                grid_path2.opacity = 0.7;
                
                grid_path2.add(new Point(topLeft.x + .5 * width, topLeft.y));
                grid_path2.add(new Point(topLeft.x + .5 * width, topLeft.y + height));
                
            } else if (grid_type === "4x4") {
                console.log('4');
                alert('4x4 grid is not available yet.');
            } else if (grid_type === "8x8") {
                alert('8x8 grid is not available yet.');
            } else if (grid_type === "16x16") {
                alert('16x16 grid is not available yet.');
            }
            
            $("#location").text(map.pointLocation(new com.modestmaps.Point(topLeft.x, topLeft.y)).toString() + ' to ' +
            map.pointLocation(new com.modestmaps.Point(last_point.x, last_point.y)).toString());
        }
    }
</script>
<style type="text/css">
    body {
      background: #fff;
      color: #000;
      font-family: Helvetica, sans-serif;
      margin: 0;
      padding: 20px;
      border: 0;
    }
    #map {
      width: 1000px;
      height: 500px;
      position: absolute;
      z-index:1;
    }
    
    #canvas {
        position: absolute;
        z-index: 2;
    }
</style>
</head>
    <body>
        <h1>Walking Papers Grid</h1>
        Choose Scale: <select id="scale">
          <option>2x2</option>
          <option>4x4</option>
          <option>8x8</option>
          <option>16x16</option>
        </select>
        <br /><br />
        Bounds: <span id="location">No Selection Made</span>
        <br /><br />
        <div id="map">
        </div>
        <canvas id="canvas" resize></canvas>
    </body>
</html>