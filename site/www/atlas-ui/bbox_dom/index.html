<!DOCTYPE html>
<html>
    <head>
        <title>Field Papers: Atlas Page Selector</title>
        <script type="text/javascript" src="js/modestmaps.js"></script>
        <script type="text/javascript" src="js/modestmaps.extent-selector.js"></script>
        
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
        <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
        
        <script type="text/javascript">
        var MM = com.modestmaps,
            map, selector, pages = [],
            rows = 0, columns = 0, aspect_ratio = 7.5/9.5,
            unscaled_page_width=75, unscaled_page_height=95, page_container,
            page_zoom = 11;
            
        function updateExtentInputs() {
            var len = pages.length;
            for (var i = 0; i < len; i++) {
                var page = pages[i],
                    northwest = map.coordinateLocation(page.coord_top_left),
                    southeast = map.coordinateLocation(page.coord_bottom_right);

                var input = document.createElement("input");
                input.setAttribute("type", "hidden");
                input.name = "pages[" + i + "]";
                input.value = [northwest.lat, southeast.lat, southeast.lon, northwest.lon].join(",");
                // TODO: append input to form
            }
        }
                   
        function setPageSize(width,height){
            page_width = width;
            page_height = height;
            aspect_ratio = page_width/page_height;
            
            updatePages(selector.extent);
        }
        
        function updatePages(extent) {
            var northwest = extent.northWest();
            var southeast = extent.southEast();
            
            var top_left = map.locationPoint(northwest),
                bottom_right = map.locationPoint(southeast),
                coord_top_left = map.pointCoordinate(top_left).zoomTo(page_zoom),
                coord_bottom_right = map.pointCoordinate(bottom_right).zoomTo(page_zoom);
            
            var width = bottom_right.x - top_left.x;
            var height = bottom_right.y - top_left.y;
            
            console.log('width: ' + width, 'height: ' + height);
            
            var page_scale = Math.pow(2,map.getZoom() - page_zoom);
            console.log('page_scale: ' + page_scale);
            
            var page_width = unscaled_page_width * page_scale;
            var page_height = unscaled_page_height * page_scale;
            
            var columns = Math.ceil(width/page_width);
            var rows = Math.ceil(height/page_height);
            var num_pages = columns * rows;
            
            var container_width = columns * page_width; //quantized width
            var container_height = rows * page_height;
            
            page_container.style.width = container_width + 'px';
            page_container.style.height = container_height + 'px';
            
            page_container.style.left = -(container_width - width)/2 + 'px';
            page_container.style.top = -(container_height - height)/2 + 'px';
            
            if(pages.length < num_pages) {
                while(pages.length < num_pages) {
                    var page = document.createElement("div");
                    page.appendChild(document.createElement("span")).setAttribute("class","page-label");
                    page.setAttribute("class","page");
                    page.style.position = "absolute";
                    page_container.appendChild(page);
                    pages.push(page);
                }
            } else if (pages.length> num_pages) {
                while(pages.length > num_pages) {
                    var page = pages.pop();
                    page_container.removeChild(page);
                }
            }
            
            var coord_top_left_offset = map.pointCoordinate(new MM.Point(top_left.x + page_width, top_left.y + page_height)).zoomTo(page_zoom);
            var col_step = coord_top_left_offset.column - coord_top_left.column;
            var row_step = coord_top_left_offset.row - coord_top_left.row;
            
            var x = 0,
                y = 0,
                row = coord_top_left.row,
                column = coord_top_left.column;
            
            for (var i=0; i < num_pages; i++) {
                var page = pages[i];
                
                var coord_tl = new MM.Coordinate(row, column, page_zoom),
                    coord_br = new MM.Coordinate(row + row_step, column + col_step, page_zoom),
                    point_tl = map.coordinatePoint(coord_tl),
                    point_br = map.coordinatePoint(coord_br);
                page.style.left = (point_tl.x - top_left.x) + 'px';
                page.style.top = (point_tl.y - top_left.y) + 'px';
                page.style.width = page_width + 'px';
                page.style.height = page_height + 'px';
                
                page.coord_top_left = coord_tl;
                page.coord_bottom_right = coord_br;
                
                if (num_pages < 400 && page_width > 20 && page_height > 20) {
                    page.firstChild.innerText = i + 1;
                } else {
                    page.firstChild.innerText = "";
                }
                
                if (x == columns - 1) {
                    row += row_step;
                    column = coord_top_left.column; 
                    x = 0;      
                    y += 1;
                } else {
                    column += col_step;
                    x += 1;
                }
            }
            
            document.getElementById("page-count").innerText = num_pages;
        }
        
        function onExtentChange(extent) {
            updatePages(extent);
        }            

        function initMap() {
            // the map
            var provider = new MM.TemplatedMapProvider("http://tile.openstreetmap.org/{Z}/{X}/{Y}.png");
            map = new MM.Map("map", provider);

            // the initial extent
            var extent = new MM.MapExtent(37.837, -122.522, 37.691, -122.350);
            map.setExtent(extent);

            // the selector is a map "layer"
            selector = new MM.ExtentSelector(document.getElementById("extent"));
            map.addLayer(selector);
            
            page_container = document.getElementById("pages");

            // update the northwest and south east labels when the extent
            // changes
            var extentField = document.getElementById("extent-string");
            selector.addCallback("extentset", function(o, ext) {
                // and update the extent string field for good measure
                extentField.value = ext;
                onExtentChange(ext);
            });
            selector.setExtent(extent);
            
            map.addCallback("zoomed", function() {
                    updatePages(selector.extent);
                }
            );
            map.addCallback("extentset", function() {
                    updatePages(selector.extent);
                }
            );
            
            $("#page-zoom").slider({
                min: 6,
                max: 14,
                step: 1,
                value: page_zoom
            }).bind("slide", function(e, ui) {
                page_zoom = ui.value;
                updatePages(selector.extent);
            });
        }

        </script>

        <style type="text/css">
        @import url(http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/ui-lightness/jquery-ui.css);
        @import url(style.css);
        #pages {
            position: absolute;
            z-index: 100;
            pointer-events: none;
        }
        
        #pages .page {
            border: 1px solid #ccc;
            border: 1px solid rgba(0,0,0,.2);
            overflow: hidden;
        }
        
        #pages .page-label {
            font-size: 10px;
            color: #999;
            color: rgba(0,0,0,.5);

            position: absolute;
            left: 0;
            top: 50%;
            width: 100%;
            text-align: center;
            line-height: 100%;
            margin-top: -.5em;
        }
        
        #page-zoom {
            display: inline-block;
            width: 300px;
            margin-right: 15px;
        }
        </style>
    </head>
    <body onload="initMap()">
        <h1>Field Papers: Atlas Page Selector</h1>
        <p>Extent (N,W,S,E): <input id="extent-string" type="text" size="40"></p>
        <p>Page Zoom: <span id="page-zoom"></span>
            Page Count: <span id="page-count"></span>
        </p>
        <div id="map">
            <div id="extent" class="map-extent">
                <div id="pages"></div>
                <span id="nw-label" class="label"></span>
                <span id="se-label" class="label"></span>
            </div>
        </div>
    </body>
</html>
