<!DOCTYPE html>
<html>
<head>
    <title>Field Papers Paint</title>
    <script type="text/javascript" src="../js/modest_maps/modestmaps.js"></script>
    <script type="text/javascript" src="../js/paperjs/lib/paper_new.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css" />
    <script type="text/javascript">            
            // Globals for drawn paths
            var paths = [];
            var draw_on = false;
            var map;
            
            function clearPaths() {
                if (paths.length > 0) {
                    for (var i = 0; i < paths.length; i++) {
                        paths[i].remove();
                    }
                    // Empty the paths array
                    paths.length = 0;
                }
                
                paper.view.draw();
           }
           
           /*
           // Commented out for now
           function scalePaths() {
                if (paths.length > 0) {
                    for (var i=0; i < paths.length; i++) {
                        // Scale the paths
                    }
                }
                
                paper.view.draw();
           }
           */
    
            window.onload = function () {        
                var MM = com.modestmaps;
            
                map = new MM.Map('map', 
                                  new MM.TemplatedMapProvider('http://tile.openstreetmap.org/{Z}/{X}/{Y}.png')); 
            
                map.setCenterZoom(new MM.Location(37.76, -122.45), 12);
                
                // Set Zoom levels
                $("a#continent").click(function(event){
                    map.setZoom(2);
                });
                
                $("a#country").click(function(event){
                    map.setZoom(4);
                });
                
                $("a#state").click(function(event){
                    map.setZoom(6);
                });
                
                $("a#city").click(function(event){
                    map.setZoom(12);
                });
                
                $("a#neighborhood").click(function(event){
                    map.setZoom(14);
                });
                
                $("a#street").click(function(event){
                    map.setZoom(17);
                });
                
                // Map dimensions
                // 1000x500
                // Middle third 333 to 666
                //
        
                paper.install(window); // Global
                paper.setup('canvas');
                    
                paper.view.draw();
                
                $("#draw").button( {
                    text: false,
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                })
                .click(function() {
                    if (this.checked) {
                        draw_on = true;
                        
                        $('#canvas').css({cursor: 'crosshair'});
                    } else {
                        draw_on = false;
                        $('#canvas').css({cursor: ''});
                    }
                });
                
                $("#clear").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-cancel"
                    }
                })
                .click(function() { 
                    clearPaths();
                });
                
                $("#zoom-in").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-plus"
                    }
                })
                .click(function() { 
                    map.zoomIn();
                    console.log('Zoom level: ' + map.getZoom());
                });
                
                $("#zoom-out").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-minus"
                    }
                })
                .click(function() { 
                    map.zoomOut();
                    console.log('Zoom level: ' + map.getZoom());
                });
                           
                var tool = new Tool();
                var activeDrag = null;
                
                var path = null;
                var hitResults = [];
                                        
                tool.onMouseDown = function(event) {
                    if (draw_on) {
                        path = new Path();
                        path.strokeColor = 'black';
                        path.strokeWidth = 5;
                        
                        event.stopPropagation();
                    }
                    
                    if (!draw_on && paths.length > 0) {
                        for (var i = 0; i < paths.length; i++) {
                                hitResults[i] = event.point.isInside(paths[i].bounds);
                        }
                        
                        for (var i = 0; i < paths.length; i++) {
                            if (hitResults[i]) {
                                activeDrag = paths[i];
                                event.stopPropagation();
                            }
                        }
                    }  
                }
                
                tool.onMouseDrag = function(event) {
                    if (draw_on) {
                        path.add(event.point);
                    }
                    
                    if (!draw_on && paths.length > 0) {
                        event.stopPropagation();
                        activeDrag.position.x += event.delta.x;
                        activeDrag.position.y += event.delta.y;                        
                    }
                }
                
                tool.onMouseUp = function(event) {
                    if (draw_on) {
                        path.simplify();
                        path.closePath();
                        path.fillColor = new RgbColor(255,255,255,.3);
                        paths.push(path);
                    }
                    
                    activeDrag = null;
                }
                
                // Commented out for now
                // map.addCallback('zoomed', scalePath);
            }
    </script>
    <style type="text/css">
        body {
          background: #fff;
          color: #000;
          font-family: Helvetica, sans-serif;
          margin: 0;
          padding: 20px;
          border: 0;
        }
        #map {
          width: 1000px;
          height: 500px;
          position: absolute;
          z-index:1;
        }
        
        #canvas {
            position: absolute;
            z-index: 2;
        }
        
        .menu {
            width: 500px;
            padding: 5px;
            margin: 0px 0px 10px 0px;
            font-size: 10px;
        }
        
        div#container {
          width: 1000px;
          height: 500px;
        }
        
        p#footer {
            margin-top: 25px;
            font-size: 75%;
            color: #444;
            text-align: center;
        }
        
        span#zoom-buttons {
            padding-right: 10px;
        }
    </style>
</head>
    <body>
        <h1>Field Papers: Paint</h1>
        
        <div class="menu ui-widget-header ui-corner-all">
            <span id="zoom-buttons">
                <button id="zoom-in">Zoom In</button>
                <button id="zoom-out">Zoom Out</button>
            </span>
            <input type="checkbox" id="draw" /><label for="draw">Draw</label>
            <button id="clear">Clear</button>
        </div>
        <p>Zoom: <a href="#" id="continent">Continent</a> | <a href="#" id="country">Country</a> 
        | <a href="#" id="state">State</a> | <a href="#" id="city">City</a> | <a href="#" id="neighborhood">Neighborhood</a> 
        | <a href="#" id="street">Street</a>
        </p>
        <div id ="container">
            <div id="map">
                <!-- resize? -->
                <canvas id="canvas" width= "1000px" height="500"></canvas>
            </div>
        </div>
        <p id="footer">Map imagery <a href="http://wiki.openstreetmap.org/wiki/Licence">CC-BY-SA OpenStreetMap.org contributors</a>.</p> 
    </body>
</html>