<!DOCTYPE html>
<html>
<head>
    <title>Field Papers Paint</title>
    <script type="text/javascript" src="../js/modest_maps/modestmaps.js"></script>
    <script type="text/javascript" src="../js/modest_maps/markerclip.js"></script>
    
    <script type="text/javascript" src="../js/paperjs/lib/paper_new.js"></script>
    
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <script type="text/javascript">            
            // Globals for drawn paths
            var paths = [];
            
            var map;
            var MM = com.modestmaps;
            
            // Booleans for toolbar
            var draw_on = false;
            var move_path = false;
            var pathLocationsBeforeZoom = [];
                                    
            function findPathCenter(opts) {
                // opts = [type,index]
            
                if (opts[0] === 'move') {
                    var index = opts[1];
                    
                    var pathPointBeforeZoom = [paths[index].position.x, paths[index].position.y];
                    var pathLocationBeforeZoom = map.pointLocation(new MM.Point(pathPointBeforeZoom[0],pathPointBeforeZoom[1]));
                
                    pathLocationsBeforeZoom[index] = pathLocationBeforeZoom;
                
                    return;
                }
                
                if (opts[0] === 'drawn' || opts[0] === 'map-panned') {
                    //console.log('panned1');
                    if (pathLocationsBeforeZoom.length > 0) {
                        // Empty the array before updating the location
                        pathLocationsBeforeZoom.length = 0;
                    }
                
                    for (var i = 0; i < paths.length; i++) {
                        var pathPointBeforeZoom = [paths[i].position.x, paths[i].position.y];
                        
                        var pathLocationBeforeZoom = map.pointLocation(new MM.Point(pathPointBeforeZoom[0],pathPointBeforeZoom[1]));
                    
                        pathLocationsBeforeZoom.push(pathLocationBeforeZoom);
                    }
                }
            }
                        
            function clearPaths() {
                // Add modal to clear or not?
                if (paths.length > 0) {
                    for (var i = 0; i < paths.length; i++) {
                        paths[i].remove();
                    }
                    // Empty the paths array
                    paths.length = 0;
                }
                paper.view.draw();
           }
           
           function scalePaths(zoomed_in) {
                // lat/lon have already been locked in              
                if (paths.length > 0) {
                    for (var i=0; i < paths.length; i++) {                    
                        if (zoomed_in) {
                            // Math.pow(2,map.getZoom()-orig_zooms[i])
                            
                            paths[i].scale(2);
                            
                            var path_point = map.locationPoint(new MM.Location(pathLocationsBeforeZoom[i].lat, pathLocationsBeforeZoom[i].lon));
                            paths[i].position = new Point(path_point.x,path_point.y);
                        } else if (!zoomed_in) {                  
                            paths[i].scale(.5);
                            
                            var path_point = map.locationPoint(new MM.Location(pathLocationsBeforeZoom[i].lat, pathLocationsBeforeZoom[i].lon));
                            paths[i].position = new Point(path_point.x,path_point.y);
                        }
                    }
                }
                
                paper.view.draw();
           }
           
           function translatePaths() {
                var path_point;
                for (var i=0; i < paths.length; i++) {
                    path_point = map.locationPoint(new MM.Location(pathLocationsBeforeZoom[i].lat, pathLocationsBeforeZoom[i].lon));
                    paths[i].position = new Point(path_point.x,path_point.y);
                }
                //paper.view.draw();
           }
           
           function setPapers(add) {
                // Starting to draw field papers based on drawn paths
                for (var i=0; i < paths.length; i++) {
                    if (add) {
                        paths[i].children[1].strokeColor = new RgbColor(0,0,0,1);
                    } else {
                        paths[i].children[1].strokeColor = new RgbColor(0,0,0,0);
                    }
                }
                paper.view.draw();
           }
    
            window.onload = function () {
                var orig_zooms = [];
                var zoomed_in = null;
            
                map = new MM.Map('map', 
                                  new MM.TemplatedMapProvider('http://tile.openstreetmap.org/{Z}/{X}/{Y}.png')); 
            
                map.setCenterZoom(new MM.Location(37.76, -122.45), 10);
                
                // Add a marker for testing path scale/translate
                var markerClip = new MarkerClip(map);
                var marker = markerClip.createDefaultMarker();
                var location = new MM.Location(37.76000, -122.65000);
                markerClip.addMarker(marker,location);
                
                // Set Zoom levels
                $("a#continent").click(function(event){
                    map.setZoom(2);
                });
                
                $("a#country").click(function(event){
                    map.setZoom(4);
                });
                
                $("a#state").click(function(event){
                    map.setZoom(6);
                });
                
                $("a#city").click(function(event){
                    map.setZoom(12);
                });
                
                $("a#neighborhood").click(function(event){
                    map.setZoom(14);
                });
                
                $("a#street").click(function(event){
                    map.setZoom(17);
                });
                
                // Map dimensions
                // 1000x500
                // Middle third 333 to 666
                //
        
                paper.install(window); // Global
                paper.setup('canvas');
                    
                paper.view.draw();
                
                $("#draw").button( {
                    text: false,
                    icons: {
                        primary: "ui-icon-pencil"
                    }
                })
                .click(function() {
                    if (this.checked) {
                        draw_on = true;
                        $('#canvas').css({cursor: 'crosshair'}); // not needed?
                        //ui-state-default,ui-state-active,ui-state-hover
                    } else {
                        draw_on = false;
                        $('#canvas').css({cursor: ''}); // not needed?
                    }
                });
                                
                $("#papers").button( {
                    text: false,
                    icons: {
                        primary: "ui-icon-document"
                    }
                })
                .click(function() {
                    if (this.checked) {
                        if (paths.length > 0) {                 
                            setPapers(true);
                        }
                    } else {
                        if (paths.length > 0) {
                            setPapers(false);
                        }
                    }
                });
                
                $("#clear").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-cancel"
                    }
                })
                .click(function() { 
                    clearPaths();
                });
                
                $("#zoom-in").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-plus"
                    }
                })
                .click(function() {                    
                    zoomed_in = true;
                    map.zoomIn();
                });
                
                $("#zoom-out").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-minus"
                    }
                })
                .click(function() {
                    zoomed_in = false;
                    map.zoomOut();
                });
                           
                var tool = new Tool();
                var activeDrag = null;
                
                var path = null;
                var hitResults = [];
                
                
                tool.onMouseMove = function(event) {
                    if (draw_on) {
                        $('#canvas').css({cursor: 'crosshair'});
                    } else {
                        $('#canvas').css({cursor: ''});
                    }
                    
                    if (!draw_on && paths.length > 0) {
                        for (var i = 0; i < paths.length; i++) {
                            hitResults[i] = event.point.isInside(paths[i].bounds);
                            if (hitResults[i]) {
                                $('#canvas').css({cursor: 'move'});
                            }
                        }
                    }
                }
                                        
                tool.onMouseDown = function(event) {
                    if (hitResults.length > 0) {
                        hitResults.length = 0;
                    }
                
                    if (draw_on) {
                        path = new Path();
                        path.strokeColor = 'black';
                        path.strokeWidth = 2;
                        path.selected = true;
                        
                        event.stopPropagation();
                    }
                    
                    if (!draw_on && paths.length > 0) {
                        for (var i = 0; i < paths.length; i++) {
                            hitResults[i] = event.point.isInside(paths[i].bounds);
                            if (hitResults[i]) {
                                move_path = true;
                            
                                activeDrag = paths[i];
                                event.stopPropagation();
                            }
                        }
                    }
                }
                
                var index;
                tool.onMouseDrag = function(event) {
                    if (draw_on) {
                        path.add(event.point);
                    }
                    
                    if (!draw_on && paths.length > 0) {
                        for (var i = 0; i < hitResults.length; i++) {
                            if (hitResults[i]) {
                                // Bug: double hit
                                index = i;
                                
                                event.stopPropagation();
                                activeDrag.position.x += event.delta.x;
                                activeDrag.position.y += event.delta.y;
                                
                                //activeDrag.position = new Point(activeDrag.position.x + event.delta.x, activeDrag.position.y + event.delta.y);  
                                //findPathCenter();
                            }
                        }                     
                    }
                }
                
                tool.onMouseUp = function(event) {                    
                    if (move_path) {
                        console.log(index); //rewrite findPathCenter
                        findPathCenter(['move',index]);
                        move_path = false;
                    }
                    
                    if (draw_on) {
                        path.simplify();
                        path.closePath();
                        path.fillColor = new RgbColor(255,255,255,.3);
                        
                        var rect = new Path.Rectangle(path.bounds);
                        rect.strokeColor = new RgbColor(0,0,0,0);
                        
                        /*
                        path.onMouseEnter = function() {
                            if (!draw_on && move_path) {
                                $('#canvas').css({cursor: 'move'});
                            }
                        }
                        
                        path.onMouseLeave = function() {
                            if (!draw_on && move_path) {
                                $('#canvas').css({cursor: ''});
                            }
                        }
                        
                        path.onMouseDrag = function () {
                            if (!draw_on) {
                                $('#canvas').css({cursor:'move'});
                            }
                        }
                        */
                        
                        // Creating a group for the path and its bounding rectangle
                        var group = new Group();
                        group.addChild(path);
                        group.addChild(rect);
                        
                        paths.push(group);

                        orig_zooms.push(map.getZoom());
                        
                        findPathCenter(['drawn']);
                    }
                    
                    activeDrag = null;
                }
                                                
                map.addCallback('zoomed', function() {     
                    console.log('zoomed');                   
                    scalePaths(zoomed_in);
                });
                
                map.addCallback('panned', function() {
                    console.log('panned');
                    //findPathCenter(['map-panned']);
                    translatePaths();
                });
                
                /*
                $('#map').dblclick(function () {
                    console.log('dbl');
                    //findPathCenter(['map-panned']);
                    scalePaths(zoomed_in = true);
                    translatePaths();
                });
                */
            }
    </script>
    <style type="text/css">
        @import url(style.css);
        @import url(http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css);
    </style>
</head>
    <body>
        <h2>Field Papers: Paint</h2>
        <div class="menu ui-widget-header ui-corner-all">
            <span id="zoom-buttons">
                <button id="zoom-in">Zoom In</button>
                <button id="zoom-out">Zoom Out</button>
            </span>
            <input type="checkbox" id="draw" /><label for="draw">Draw</label>
            <input type="checkbox" id="papers" /><label for="papers">Set Field Papers</label>
            <button id="clear">Clear</button>
        </div>
        <p>Zoom: <a href="#" id="continent">Continent</a> | <a href="#" id="country">Country</a> 
        | <a href="#" id="state">State</a> | <a href="#" id="city">City</a> | <a href="#" id="neighborhood">Neighborhood</a> 
        | <a href="#" id="street">Street</a>
        </p>
        <div id ="container">
            <div id="map">
                <!-- resize? -->
                <canvas id="canvas" width="1000px" height="500"></canvas>
            </div>
        </div>
        <p id="footer">Map imagery <a href="http://wiki.openstreetmap.org/wiki/Licence">CC-BY-SA OpenStreetMap.org contributors</a>.</p> 
    </body>
</html>
