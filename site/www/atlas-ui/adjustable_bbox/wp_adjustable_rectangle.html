<!DOCTYPE html>
<html>
<head>
    <title>Walking Papers Grid</title>
    <script type="text/javascript" src="../js/modest_maps/modestmaps.js"></script>
    <script type="text/javascript" src="../js/paperjs/lib/paper_new.js"></script>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <script type="text/javascript">
            var paper_width = 7.5;
            var paper_height = 9.5;
            var aspect_ratio = 7.5/9.5;
            //var scale = .015;
            //var scale = 1;
    
            var vertical_lines_array = [];
            var horizontal_lines_array = [];
            var rect_array = null;
            var text_array = null;
            
            var map;
            
            var group;
            var zoomed_in;
            
            var handle_tl, handle_tr, handle_bl, handle_br;
            var rect;
            
            function drawGrid(rect_obj,aspect_ratio) {
                console.log('zoomed');       
                var top_left = rect_obj.bounds.topLeft;
                var width = rect_obj.bounds.width;
                var height = rect_obj.bounds.height;
                //var width_gc = 1/scale; // 1/.015
                //var width_gc = 66;
                var width_gc = (paper_width/paper_height) * 60 * Math.pow(2, map.getZoom() - 11);
                //var width_gc = paper_width/paper_height;
                var height_gc = width_gc/aspect_ratio;
                
                var number_of_boxes_horizontal = Math.floor(width / width_gc) + 1;
                var number_of_boxes_vertical = Math.floor(height * aspect_ratio * 1/width_gc) + 1;
                
                
                if (rect_array && text_array) {
                    for (var i = 0; i < rect_array.length; i++) {
                        for (var j = 0; j < rect_array[i].length; j++){
                                rect_array[i][j].remove();
                                text_array[i][j].remove();
                        }
                    }
                }
                
                
                rect_array = new Array(number_of_boxes_vertical);
                text_array = new Array(number_of_boxes_vertical);
                
                group = new Group();
                group.addChild(rect_obj);
                
                var count = 0;
                
                for (var i = 0; i < number_of_boxes_vertical; i++) {
                    rect_array[i] = new Array(number_of_boxes_horizontal);
                    text_array[i] = new Array(number_of_boxes_horizontal);
                    for (var j = 0; j < number_of_boxes_horizontal; j++) {
                        rect_array[i][j] = new Path.Rectangle(new Point(top_left.x, top_left.y),new Point(top_left.x+width_gc*(j+1),top_left.y + height_gc*(i+1)));
                        rect_array[i][j].strokeColor = "#000000";
                        rect_array[i][j].closed = true;
                        
                        group.addChild(rect_array[i][j]);
                        rect_array[i][j].insertAbove(rect_obj);
                        

                        
                        
                        
                        // the text
                        text_array[i][j] = new PointText(new Point(top_left.x+width_gc*j + .5 *width_gc, top_left.y + height_gc*i + .5*height_gc));
                        text_array[i][j].characterStyle = {
                            fontSize: 44
                        };
                        text_array[i][j].fillColor = new RgbColor(0,0,0,.5);
                        text_array[i][j].content = count + 1;
                        
                        text_array[i][j].position.x -= .5 * text_array[i][j].bounds.width;
                        text_array[i][j].position.y += .5 * text_array[i][j].bounds.height - .5 * (text_array[i][j].bounds.center.y - text_array[i][j].bounds.top);
                        
                        count++;
                        
                    }
                }
                paper.view.draw();
            }
            
            function redrawRect(rect_obj,handle_tl,handle_bl,handle_tr,handle_br) {
                console.log(rect_obj.bounds.width);
                
                rect_obj.bounds.width = rect_obj.bounds.width * .25 * Math.pow(2, map.getZoom() - 11);
                rect_obj.bounds.height = rect_obj.bounds.height * .25 * Math.pow(2, map.getZoom() - 11);
            
                paper.view.draw();
            }
            
            function scale() {
                if(zoomed_in){
                    group.scale(2);
                } else if (!zoomed_in) {
                    group.scale(.5);
                }
                
                // Position of the handles
                handle_tl.position.x = group.bounds.topLeft.x;
                handle_tl.position.y = group.bounds.topLeft.y;
                
                handle_tr.position.x = group.bounds.topLeft.x + group.bounds.width;
                handle_tr.position.y = group.bounds.topLeft.y;
                
                handle_bl.position.x = group.bounds.topLeft.x;
                handle_bl.position.y = group.bounds.topLeft.y + group.bounds.height;
                
                handle_br.position.x = group.bounds.topLeft.x + group.bounds.width;
                handle_br.position.y = group.bounds.topLeft.y + group.bounds.height;
                
                // Position the text
                /*
                for (var i=0; i < text_array.length; i++) {
                    for (var j=0; j < text_array[i].length; j++) {
                        text_array[i][j].position.x =.5 * text_array[i][j].position.x;
                    } 
                }
                */
                paper.view.draw();
            }
    
            window.onload = function () {  
                //var zoomed_in = null;
                      
                var MM = com.modestmaps;
            
                map = new MM.Map('map', 
                                  new MM.TemplatedMapProvider('http://tile.openstreetmap.org/{Z}/{X}/{Y}.png')); 
            
                map.setCenterZoom(new MM.Location(37.76, -122.45), 12);
                
                //Set Zoom levels
                $("a#continent").click(function(event){
                    map.setZoom(2);
                });
                
                $("a#country").click(function(event){
                    map.setZoom(4);
                });
                
                $("a#state").click(function(event){
                    map.setZoom(6);
                });
                
                $("a#city").click(function(event){
                    map.setZoom(12);
                });
                
                $("a#neighborhood").click(function(event){
                    map.setZoom(14);
                });
                
                $("a#street").click(function(event){
                    map.setZoom(17);
                });
        
                var radius = 6;
                var diameter = 12;
                var threshold = 2;
                var handle_size_tot = 14;
                
                //map dimensions
                //1000x500
                //middle third 333 to 666
                //
        
                paper.install(window); // global
                paper.setup('canvas');
                            
                //Create Rectangle
                rect = new Path.Rectangle(new Point(333,166), new Point(666, 333));
                rect.strokeColor = '#000000';
                rect.strokeWidth = 2;
                rect.dashArray = [12,6];
                rect.fillColor = '#e9e9ff';
                rect.opacity = 0.5;
                rect.closed = true;
                
                //Create four handles
                handle_tl = new Path.Circle(new Point(333,166), radius);
                handle_tl.fillColor = '#ffffff';
                handle_tl.strokeWidth = 2;
                handle_tl.strokeColor = '#000000';
                handle_tl.smooth();
                
                handle_tr = new Path.Circle(new Point(666,166), radius);
                handle_tr.fillColor = '#ffffff';
                handle_tr.strokeWidth = 2;
                handle_tr.strokeColor = '#000000';
                handle_tr.smooth();
                     
                handle_br = new Path.Circle(new Point(666,333), radius);
                handle_br.fillColor = '#ffffff';
                handle_br.strokeWidth = 2;
                handle_br.strokeColor = '#000000';
                handle_br.smooth();
                
                handle_bl = new Path.Circle(new Point(333,333), radius);
                handle_bl.fillColor = '#ffffff';
                handle_bl.strokeWidth = 2;
                handle_bl.strokeColor = '#000000';
                handle_bl.smooth();
                    
                paper.view.draw();
                                
                var hitResult_tl;
                var hitResult_tr;
                var hitResult_br;
                var hitResult_bl;
                
                var hitResult_rect;
                
                var hitOptions = {
                    segments: true,
                    stroke: true,
                    fill: true,
                    tolerance: 5
                };
                
                var tool = new Tool();
                var activeDrag = null;
                        
                tool.onMouseDown = function(event) {
                    hitResult_tl = event.point.isInside(handle_tl.bounds);
                    hitResult_tr = event.point.isInside(handle_tr.bounds);
                    hitResult_br = event.point.isInside(handle_br.bounds);
                    hitResult_bl = event.point.isInside(handle_bl.bounds);
                    
                    if (hitResult_tl) {
                        activeDrag = handle_tl;
                        event.stopPropagation();
                    } else if (hitResult_tr) {
                        activeDrag = handle_tr;
                        event.stopPropagation();
                    } else if (hitResult_br) {
                        activeDrag  = handle_br;
                        event.stopPropagation();
                    } else if (hitResult_bl) {
                        activeDrag = handle_bl; 
                        event.stopPropagation();
                    }
                    
                    //Handle the rectangle
                    hitResult_rect = rect.hitTest(event.point, hitOptions);
                    
                    if (hitResult_rect) {
                        event.stopPropagation();
                    }
                    
                    $("canvas").css({'cursor':'move'});
                }
                
                tool.onMouseDrag = function(event) {
                    if (activeDrag == handle_tl){
                        handle_tl.position.x = event.point.x;
                        handle_bl.position.x += event.delta.x;
        
                        handle_tl.position.y = event.point.y;
                            
                        handle_tr.position.y += event.delta.y;
                    } else if (activeDrag == handle_tr) {
                        handle_tr.position.x = event.point.x;
                        handle_tr.position.y = event.point.y;
                        
                        handle_br.position.x += event.delta.x;
                        
                        handle_tl.position.y += event.delta.y;
                    } else if (activeDrag == handle_br) {
                        handle_br.position.x = event.point.x;
                        handle_br.position.y = event.point.y;
                        
                        handle_tr.position.x += event.delta.x;
                        
                        handle_bl.position.y += event.delta.y;
                    } else if (activeDrag == handle_bl) {
                        handle_bl.position.x = event.point.x;
                        handle_bl.position.y = event.point.y;
                        
                        handle_tl.position.x += event.delta.x;
                        
                        handle_br.position.y += event.delta.y;
                    }
                    
                    if (hitResult_tl || hitResult_tr || hitResult_br || hitResult_bl) {
                        rect.remove();
                        
                        handle_bl.position.x = handle_tl.position.x;
                        handle_bl.position.y = handle_br.position.y;
                        
                        handle_tr.position.x = handle_br.position.x;
                        handle_tr.position.y = handle_tl.position.y;
                        
                        rect = new Path.Rectangle(new Point(handle_tl.position.x,handle_tl.position.y), new Point(handle_br.position.x,handle_br.position.y));
                        rect.strokeColor = '#000000';
                        rect.strokeWidth = 2;
                        rect.dashArray = [12,6];
                        rect.fillColor = '#e9e9ff';
                        rect.opacity = 0.5;
                        rect.closed = true;
                        //rect.selected = true;
                        
                        handle_tl.insertAbove(rect);
                        handle_tr.insertAbove(rect);
                        handle_bl.insertAbove(rect);
                        handle_br.insertAbove(rect);
                        
                        drawGrid(rect,aspect_ratio);
                    } else if (hitResult_rect) {
                        handle_br.position.x += event.delta.x;
                        handle_br.position.y += event.delta.y;
                        
                        handle_bl.position.x += event.delta.x;
                        handle_bl.position.y += event.delta.y;
                        
                        handle_tr.position.x += event.delta.x;
                        handle_tr.position.y += event.delta.y;
                        
                        handle_tl.position.x += event.delta.x;
                        handle_tl.position.y += event.delta.y;
                        
                        rect.position.x += event.delta.x;
                        rect.position.y += event.delta.y;
                        
                        drawGrid(rect,aspect_ratio);
                    }
                    
                    var last_point = event.point;
                
                    $("span#location").text(map.pointLocation(new com.modestmaps.Point(rect.bounds.topLeft.x, rect.bounds.topLeft.y)).toString() + ' to ' +
                    map.pointLocation(new com.modestmaps.Point(last_point.x, last_point.y)).toString());
                }
                
                tool.onMouseUp = function(event) {
                    activeDrag = null;
                    $("canvas").css({'cursor':'default'});
                }
                
                //Deal with changes from the paper size selection
                $("select#paper_size").change(function(){
                    //this gets called immediately
                
                    var value = $("select#paper_size").val();
                    
                    if (value == "Letter"){
                        paper_width = 7.5;
                        paper_height = 9.5;
                    } else if (value == "A4") {
                        paper_width = 7.268;
                        paper_height = 10.1929;      
                    } else if (value == "A3") {
                        paper_width = 10.6929;
                        paper_height = 15.0354;
                    }
                    
                    aspect_ratio = paper_width/paper_height;
                    
                    drawGrid(rect,aspect_ratio);
                });
                
                $("#zoom-in").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-plus"
                    }
                })
                .click(function() {                    
                    zoomed_in = true;
                    map.zoomIn();
                });
                
                $("#zoom-out").button({
                    text: false,
                    icons: {
                        primary: "ui-icon-minus"
                    }
                })
                .click(function() {
                    zoomed_in = false;
                    map.zoomOut();
                });
                
                map.addCallback('zoomed',function() {
                    //drawGrid(rect,aspect_ratio);
                    //redrawRect(rect,handle_tl,handle_bl,handle_tr,handle_br);
                    scale();
                });
            }
    </script>
<style type="text/css">
    @import url(http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.9/themes/base/jquery-ui.css);
    body {
      background: #fff;
      color: #000;
      font-family: Helvetica, sans-serif;
      margin: 0;
      padding: 20px;
      border: 0;
    }
    #map {
      width: 1000px;
      height: 500px;
      position: absolute;
      z-index:1;
    }
    
    #canvas {
        position: absolute;
        z-index: 2;
    }
    
    .menu {
        width: 200px;
        padding: 5px;
        margin: 0px 0px 10px 0px;
        font-size: 10px;
    }
    
    span#zoom-buttons {
        padding-right: 10px;
    }
</style>
</head>
    <body>
        <h1>Walking Papers Grid</h1>
        Choose Aspect Ratio for Field Papers: <select id="paper_size">
          <option>Letter</option>
          <option>A4</option>
          <option>A3</option>
        </select>
        <br /><br />
        Bounds: <span id="location">No Selection Made</span>
        <br />
        <p>Zoom: <a href="#" id="continent">Continent</a> | <a href="#" id="country">Country</a> 
        | <a href="#" id="state">State</a> | <a href="#" id="city">City</a> | <a href="#" id="neighborhood">Neighborhood</a> 
        | <a href="#" id="street">Street</a>
        </p>
        <div class="menu ui-widget-header ui-corner-all">
            <span id="zoom-buttons">
                <button id="zoom-in">Zoom In</button>
                <button id="zoom-out">Zoom Out</button>
            </span>
        </div>
        <div id="map">
            <canvas id="canvas" resize></canvas>
        </div>
    </body>
</html>